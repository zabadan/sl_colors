'use strict';

<<<<<<< HEAD
=======
var fs = require('fs');
>>>>>>> 60c0efd51e9c4271a396c74cb37c9681801184ab
var writeDir = require('./writeDir');
var writeStream = require('./writeStream');
var writeBuffer = require('./writeBuffer');
var writeSymbolicLink = require('./writeSymbolicLink');

<<<<<<< HEAD
function writeContents(writePath, file, callback) {
  // If directory then mkdirp it
=======
function writeContents(writePath, file, cb) {
  // if directory then mkdirp it
>>>>>>> 60c0efd51e9c4271a396c74cb37c9681801184ab
  if (file.isDirectory()) {
    return writeDir(writePath, file, written);
  }

<<<<<<< HEAD
  // Stream it to disk yo
=======
  // stream it to disk yo
>>>>>>> 60c0efd51e9c4271a396c74cb37c9681801184ab
  if (file.isStream()) {
    return writeStream(writePath, file, written);
  }

<<<<<<< HEAD
  // Write it as a symlink
=======
  // write it as a symlink
>>>>>>> 60c0efd51e9c4271a396c74cb37c9681801184ab
  if (file.symlink) {
    return writeSymbolicLink(writePath, file, written);
  }

<<<<<<< HEAD
  // Write it like normal
=======
  // write it like normal
>>>>>>> 60c0efd51e9c4271a396c74cb37c9681801184ab
  if (file.isBuffer()) {
    return writeBuffer(writePath, file, written);
  }

<<<<<<< HEAD
  // If no contents then do nothing
  if (file.isNull()) {
    return written();
  }

  // This is invoked by the various writeXxx modules when they've finished
  // writing the contents.
  function written(err) {
    if (isErrorFatal(err)) {
      return callback(err);
    }

    callback(null, file);
=======
  // if no contents then do nothing
  if (file.isNull()) {
    return complete();
  }

  function complete(err) {
    cb(err, file);
  }

  function written(err) {

    if (isErrorFatal(err)) {
      return complete(err);
    }

    if (!file.stat || typeof file.stat.mode !== 'number' || file.symlink) {
      return complete();
    }

    fs.stat(writePath, function(err, st) {
      if (err) {
        return complete(err);
      }
      var currentMode = (st.mode & parseInt('0777', 8));
      var expectedMode = (file.stat.mode & parseInt('0777', 8));
      if (currentMode === expectedMode) {
        return complete();
      }
      fs.chmod(writePath, expectedMode, complete);
    });
>>>>>>> 60c0efd51e9c4271a396c74cb37c9681801184ab
  }

  function isErrorFatal(err) {
    if (!err) {
      return false;
    }

<<<<<<< HEAD
    if (err.code === 'EEXIST' && file.flag === 'wx') {
      // Handle scenario for file overwrite failures.
=======
    // Handle scenario for file overwrite failures.
    else if (err.code === 'EEXIST' && file.flag === 'wx') {
>>>>>>> 60c0efd51e9c4271a396c74cb37c9681801184ab
      return false;   // "These aren't the droids you're looking for"
    }

    // Otherwise, this is a fatal error
    return true;
  }
}

module.exports = writeContents;
