'use strict';

var assign = require('object-assign');
<<<<<<< HEAD
var through2 = require('through2');
var gs = require('glob-stream');
=======
var through = require('through2');
var gs = require('glob-stream');
var File = require('vinyl');
>>>>>>> 60c0efd51e9c4271a396c74cb37c9681801184ab
var duplexify = require('duplexify');
var merge = require('merge-stream');
var sourcemaps = require('gulp-sourcemaps');
var filterSince = require('../filterSince');
var isValidGlob = require('is-valid-glob');

var getContents = require('./getContents');
<<<<<<< HEAD
var wrapWithVinylFile = require('./wrapWithVinylFile');
=======
var resolveSymlinks = require('./resolveSymlinks');

function createFile(globFile, enc, cb) {
  cb(null, new File(globFile));
}
>>>>>>> 60c0efd51e9c4271a396c74cb37c9681801184ab

function src(glob, opt) {
  var options = assign({
    read: true,
    buffer: true,
    stripBOM: true,
    sourcemaps: false,
    passthrough: false,
<<<<<<< HEAD
    followSymlinks: true,
  }, opt);

  // Don't pass `read` option on to through2
  var read = options.read !== false;
  options.read = undefined;

=======
    followSymlinks: true
  }, opt);

>>>>>>> 60c0efd51e9c4271a396c74cb37c9681801184ab
  var inputPass;

  if (!isValidGlob(glob)) {
    throw new Error('Invalid glob argument: ' + glob);
  }

  var globStream = gs.create(glob, options);

  var outputStream = globStream
<<<<<<< HEAD
    .pipe(wrapWithVinylFile(options));
=======
    .pipe(resolveSymlinks(options))
    .pipe(through.obj(createFile));
>>>>>>> 60c0efd51e9c4271a396c74cb37c9681801184ab

  if (options.since != null) {
    outputStream = outputStream
      .pipe(filterSince(options.since));
  }

<<<<<<< HEAD
  if (read) {
=======
  if (options.read !== false) {
>>>>>>> 60c0efd51e9c4271a396c74cb37c9681801184ab
    outputStream = outputStream
      .pipe(getContents(options));
  }

  if (options.passthrough === true) {
<<<<<<< HEAD
    inputPass = through2.obj(options);
=======
    inputPass = through.obj();
>>>>>>> 60c0efd51e9c4271a396c74cb37c9681801184ab
    outputStream = duplexify.obj(inputPass, merge(outputStream, inputPass));
  }
  if (options.sourcemaps === true) {
    outputStream = outputStream
<<<<<<< HEAD
      .pipe(sourcemaps.init({ loadMaps: true }));
=======
      .pipe(sourcemaps.init({loadMaps: true}));
>>>>>>> 60c0efd51e9c4271a396c74cb37c9681801184ab
  }
  globStream.on('error', outputStream.emit.bind(outputStream, 'error'));
  return outputStream;
}

module.exports = src;
